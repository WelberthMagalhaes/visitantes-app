name: Keep Render Awake

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest

    steps:
      - name: Determinar horário (SP)
        id: time
        run: |
          export TZ="America/Sao_Paulo"
          echo "hora=$(date +'%H')" >> $GITHUB_OUTPUT
          echo "dia=$(date +'%u')" >> $GITHUB_OUTPUT

      - name: Verificar se está no horário de culto
        id: allowed
        run: |
          HORA=${{ steps.time.outputs.hora }}
          DIA=${{ steps.time.outputs.dia }}

          if [ "$DIA" -eq 1 ] && [ "$HORA" -ge 17 ] && [ "$HORA" -le 21 ]; then
            echo "permitido=true" >> $GITHUB_OUTPUT; exit 0;
          fi

          if [ "$DIA" -eq 2 ] && [ "$HORA" -ge 19 ] && [ "$HORA" -le 21 ]; then
            echo "permitido=true" >> $GITHUB_OUTPUT; exit 0;
          fi

          if [ "$DIA" -eq 4 ] && [ "$HORA" -ge 19 ] && [ "$HORA" -le 21 ]; then
            echo "permitido=true" >> $GITHUB_OUTPUT; exit 0;
          fi

          if [ "$DIA" -eq 7 ] && [ "$HORA" -ge 18 ] && [ "$HORA" -le 21 ]; then
            echo "permitido=true" >> $GITHUB_OUTPUT; exit 0;
          fi

          echo "permitido=false" >> $GITHUB_OUTPUT

      - name: Fora do horário (ignorar)
        if: steps.allowed.outputs.permitido == 'false'
        run: echo "Fora do horário de culto."

      - name: Ping no Render
        if: steps.allowed.outputs.permitido == 'true'
        run: |
          curl -s \
            -H "X-API-KEY: ${{ secrets.RENDER_API_KEY }}" \
            https://visitantes-app.onrender.com/api/health
