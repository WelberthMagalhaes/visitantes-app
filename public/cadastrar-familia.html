<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Cadastro de Famílias</title>
    <link rel="stylesheet" href="/style.css" />
    <style>
      .membro-item {
        border: 1px solid #ddd;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
        background: #f9f9f9;
      }
      .membro-item h4 {
        margin: 0 0 10px 0;
        color: #333;
      }
      .btn-remover {
        background: #dc3545;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        float: right;
      }
      .btn-adicionar {
        background: #28a745;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 3px;
        cursor: pointer;
        margin: 10px 0;
      }
      .nav-links {
        text-align: center;
        margin: 20px 0;
      }
      .nav-links a {
        margin: 0 10px;
        color: #007bff;
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <!-- Tela de Login -->
    <div class="login-screen container">
      <h2>Acesso à Recepção</h2>
      <form id="loginForm">
        <label for="senha">Senha:</label>
        <input id="senha" type="password" required />
        <button type="submit">Entrar</button>
      </form>
      <p id="loginMsg"></p>
    </div>

    <!-- Tela Principal -->
    <div class="main-screen container" style="display: none">
      <div class="nav-links">
        <a href="/cadastrar.html">Cadastro Individual</a> | 
        <a href="/cadastrar-familia.html">Cadastro Família</a>
      </div>
      
      <h2>Cadastro de Família</h2>

      <form id="familiaForm">
        <label for="nomeFamilia">Nome da Família:</label>
        <input id="nomeFamilia" name="nomeFamilia" placeholder="Ex: Família Silva" required />

        <div id="membros">
          <h3>Membros da Família</h3>
          <div class="membro-item">
            <h4>Membro 1</h4>
            <button type="button" class="btn-remover" onclick="removerMembro(this)" style="display:none">Remover</button>
            <label>Nome:</label>
            <input name="nome[]" required />
            <label>Telefone:</label>
            <input name="telefone[]" />
            <label>Parentesco:</label>
            <select name="parentesco[]" required>
              <option value="">Selecione...</option>
              <option value="esposo">Esposo</option>
              <option value="esposa">Esposa</option>
              <option value="filho">Filho</option>
              <option value="filha">Filha</option>
              <option value="pai">Pai</option>
              <option value="mãe">Mãe</option>
              <option value="avô">Avô</option>
              <option value="avó">Avó</option>
              <option value="neto">Neto</option>
              <option value="neta">Neta</option>
              <option value="sobrinho">Sobrinho</option>
              <option value="sobrinha">Sobrinha</option>
              <option value="tio">Tio</option>
              <option value="tia">Tia</option>
              <option value="primo">Primo</option>
              <option value="prima">Prima</option>
              <option value="cunhado">Cunhado</option>
              <option value="cunhada">Cunhada</option>
              <option value="genro">Genro</option>
              <option value="nora">Nora</option>
              <option value="sogro">Sogro</option>
              <option value="sogra">Sogra</option>
            </select>
          </div>
        </div>

        <button type="button" class="btn-adicionar" onclick="adicionarMembro()">+ Adicionar Membro</button>
        <br>
        <button type="submit">Registrar Família</button>
      </form>

      <p id="msg"></p>
    </div>

    <script>
      const BASE = "";
      let autenticado = false;
      let contadorMembros = 1;

      function adicionarMembro() {
        contadorMembros++;
        const membrosDiv = document.getElementById('membros');
        const novoMembro = document.createElement('div');
        novoMembro.className = 'membro-item';
        novoMembro.innerHTML = `
          <h4>Membro ${contadorMembros}</h4>
          <button type="button" class="btn-remover" onclick="removerMembro(this)">Remover</button>
          <label>Nome:</label>
          <input name="nome[]" required />
          <label>Telefone:</label>
          <input name="telefone[]" />
          <label>Parentesco:</label>
          <select name="parentesco[]" required>
            <option value="">Selecione...</option>
            <option value="esposo">Esposo</option>
            <option value="esposa">Esposa</option>
            <option value="filho">Filho</option>
            <option value="filha">Filha</option>
            <option value="pai">Pai</option>
            <option value="mãe">Mãe</option>
            <option value="avô">Avô</option>
            <option value="avó">Avó</option>
            <option value="neto">Neto</option>
            <option value="neta">Neta</option>
            <option value="sobrinho">Sobrinho</option>
            <option value="sobrinha">Sobrinha</option>
            <option value="tio">Tio</option>
            <option value="tia">Tia</option>
            <option value="primo">Primo</option>
            <option value="prima">Prima</option>
            <option value="cunhado">Cunhado</option>
            <option value="cunhada">Cunhada</option>
            <option value="genro">Genro</option>
            <option value="nora">Nora</option>
            <option value="sogro">Sogro</option>
            <option value="sogra">Sogra</option>
          </select>
        `;
        membrosDiv.appendChild(novoMembro);
        atualizarBotoesRemover();
      }

      function removerMembro(btn) {
        btn.parentElement.remove();
        atualizarNumeracao();
        atualizarBotoesRemover();
      }

      function atualizarNumeracao() {
        const membros = document.querySelectorAll('.membro-item');
        membros.forEach((membro, index) => {
          membro.querySelector('h4').textContent = `Membro ${index + 1}`;
        });
        contadorMembros = membros.length;
      }

      function atualizarBotoesRemover() {
        const botoes = document.querySelectorAll('.btn-remover');
        botoes.forEach(btn => {
          btn.style.display = botoes.length > 1 ? 'block' : 'none';
        });
      }

      async function fazerLogin(senha) {
        try {
          const res = await fetch((BASE || "") + "/interno/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ senha }),
          });
          if (res.ok) {
            autenticado = true;
            return true;
          }
        } catch (err) {
          console.error("Erro no login:", err);
        }
        return false;
      }

      function mostrarLogin() {
        document.querySelector(".login-screen").style.display = "block";
        document.querySelector(".main-screen").style.display = "none";
      }

      function mostrarPrincipal() {
        document.querySelector(".login-screen").style.display = "none";
        document.querySelector(".main-screen").style.display = "block";
      }

      async function enviarFamiliaAoBackend(nomeFamilia, membros) {
        if (!autenticado) return null;

        try {
          const payload = { nomeFamilia, membros };
          const res = await fetch((BASE || "") + "/interno/familias", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          return await res.json();
        } catch (err) {
          console.error("Erro enviando família ao backend", err);
          return null;
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        mostrarLogin();

        // Login
        const loginForm = document.querySelector("#loginForm");
        const loginMsg = document.querySelector("#loginMsg");

        loginForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const senha = document.querySelector("#senha").value;

          const sucesso = await fazerLogin(senha);
          if (sucesso) {
            mostrarPrincipal();
            loginMsg.textContent = "";
          } else {
            loginMsg.textContent = "Senha incorreta";
            loginMsg.style.color = "red";
          }
        });

        // Form família
        const familiaForm = document.querySelector("#familiaForm");
        const msg = document.querySelector("#msg");

        familiaForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          
          const nomeFamilia = document.querySelector("#nomeFamilia").value.trim();
          const nomes = Array.from(document.querySelectorAll('input[name="nome[]"]')).map(i => i.value.trim());
          const telefones = Array.from(document.querySelectorAll('input[name="telefone[]"]')).map(i => i.value.trim());
          const parentescos = Array.from(document.querySelectorAll('select[name="parentesco[]"]')).map(s => s.value);

          if (!nomeFamilia || nomes.some(n => !n) || parentescos.some(p => !p)) {
            msg.textContent = "Preencha todos os campos obrigatórios";
            msg.style.color = "red";
            return;
          }

          const membros = nomes.map((nome, i) => ({
            nome,
            telefone: telefones[i],
            parentesco: parentescos[i]
          }));

          const resultado = await enviarFamiliaAoBackend(nomeFamilia, membros);

          if (resultado && resultado.status === "ok") {
            if (resultado.res.tipo === "ja_cadastrado_hoje") {
              msg.textContent = `${resultado.res.nome} já foi cadastrado hoje!`;
              msg.style.color = "orange";
            } else {
              msg.textContent = `Família "${nomeFamilia}" cadastrada com sucesso!`;
              msg.style.color = "green";
              familiaForm.reset();
              
              // Reset para 1 membro
              const membrosDiv = document.getElementById('membros');
              const primeiraMembro = membrosDiv.querySelector('.membro-item');
              membrosDiv.innerHTML = '';
              membrosDiv.appendChild(primeiraMembro);
              contadorMembros = 1;
              atualizarBotoesRemover();
            }
          } else {
            msg.textContent = "Erro ao cadastrar família";
            msg.style.color = "red";
          }
        });
      });
    </script>
  </body>
</html>