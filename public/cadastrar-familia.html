<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Cadastro de Família</title>
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <!-- Tela de Login -->
    <div class="login-screen container">
      <h2>Acesso à Recepção</h2>
      <form id="loginForm">
        <label for="senha">Senha:</label>
        <input id="senha" type="password" required />
        <button type="submit">Entrar</button>
      </form>
      <p id="loginMsg"></p>
    </div>

    <!-- Tela Principal -->
    <div class="main-screen container" style="display: none">
      <div style="text-align: center; margin: 20px 0;">
        <a href="/cadastrar.html" style="margin: 0 10px; color: #007bff; text-decoration: none;">Cadastro Individual</a> | 
        <a href="/cadastrar-familia.html" style="margin: 0 10px; color: #007bff; text-decoration: none;">Cadastro Família</a>
      </div>
      
      <h2>Cadastro de Família</h2>

      <form id="familiaForm">
        <label for="nomeFamilia">Nome da Família:</label>
        <input id="nomeFamilia" required />

        <div id="membros">
          <h3>Membros da Família</h3>
          <div class="membro">
            <input type="text" placeholder="Nome" class="nome-membro" required />
            <input type="text" placeholder="Telefone" class="telefone-membro" />
            <select class="parentesco-membro">
              <option value="">Parentesco</option>
              <option value="pai">Pai</option>
              <option value="mae">Mãe</option>
              <option value="filho">Filho(a)</option>
              <option value="avo">Avô/Avó</option>
              <option value="outro">Outro</option>
            </select>
          </div>
        </div>

        <button type="button" id="adicionarMembro">+ Adicionar Membro</button>
        <button type="submit">Cadastrar Família</button>
      </form>

      <p id="msg"></p>
    </div>

    <script>
      const BASE = "";
      let autenticado = false;

      // Verifica se já está autenticado
      async function verificarSessao() {
        try {
          const res = await fetch((BASE || "") + "/interno/visitantes/all");
          if (res.ok) {
            autenticado = true;
            return true;
          }
        } catch (err) {
          console.log("Sessão não ativa");
        }
        return false;
      }

      // Faz login
      async function fazerLogin(senha) {
        try {
          const res = await fetch((BASE || "") + "/interno/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ senha }),
          });

          if (res.ok) {
            autenticado = true;
            return true;
          }
        } catch (err) {
          console.error("Erro no login:", err);
        }
        return false;
      }

      // Mostra/esconde telas
      function mostrarLogin() {
        document.querySelector(".login-screen").style.display = "block";
        document.querySelector(".main-screen").style.display = "none";
      }

      function mostrarPrincipal() {
        document.querySelector(".login-screen").style.display = "none";
        document.querySelector(".main-screen").style.display = "block";
      }

      // Adicionar membro
      function adicionarMembro() {
        const membrosDiv = document.querySelector("#membros");
        const novoMembro = document.createElement("div");
        novoMembro.className = "membro";
        novoMembro.innerHTML = `
          <input type="text" placeholder="Nome" class="nome-membro" required />
          <input type="text" placeholder="Telefone" class="telefone-membro" />
          <select class="parentesco-membro">
            <option value="">Parentesco</option>
            <option value="pai">Pai</option>
            <option value="mae">Mãe</option>
            <option value="filho">Filho(a)</option>
            <option value="avo">Avô/Avó</option>
            <option value="outro">Outro</option>
          </select>
          <button type="button" onclick="this.parentElement.remove()">Remover</button>
        `;
        membrosDiv.appendChild(novoMembro);
        
        // Aplica autocomplete no novo input
        const novoInput = novoMembro.querySelector(".nome-membro");
        setupAutocomplete(novoInput);
      }

      // Cadastrar família
      async function cadastrarFamilia(nomeFamilia, membros) {
        if (!autenticado) return null;

        try {
          const payload = { nomeFamilia, membros };
          const res = await fetch((BASE || "") + "/interno/familia", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          return await res.json();
        } catch (err) {
          console.error("Erro cadastrando família:", err);
          return null;
        }
      }

      // Autocomplete para membros
      let visitantesCache = [];

      async function carregarVisitantes() {
        if (!autenticado) return;
        try {
          const res = await fetch((BASE || "") + "/interno/visitantes/all");
          if (res.ok) {
            visitantesCache = await res.json();
          }
        } catch (err) {
          console.error("Erro carregando visitantes:", err);
        }
      }

      function setupAutocomplete(input) {
        const wrapper = document.createElement("div");
        wrapper.style.position = "relative";
        input.parentNode.insertBefore(wrapper, input);
        wrapper.appendChild(input);

        const sugestoes = document.createElement("div");
        sugestoes.className = "sugestoes";
        sugestoes.style.position = "absolute";
        sugestoes.style.top = "100%";
        sugestoes.style.left = "0";
        sugestoes.style.right = "0";
        sugestoes.style.background = "white";
        sugestoes.style.border = "1px solid #ccc";
        sugestoes.style.maxHeight = "200px";
        sugestoes.style.overflowY = "auto";
        sugestoes.style.zIndex = "1000";
        wrapper.appendChild(sugestoes);

        input.addEventListener("input", () => {
          const valor = input.value.toLowerCase();
          sugestoes.innerHTML = "";

          if (!valor) return;

          const resultados = visitantesCache.filter(v => 
            v.nome.toLowerCase().includes(valor)
          ).slice(0, 5);

          resultados.forEach(v => {
            const item = document.createElement("div");
            item.style.padding = "8px";
            item.style.cursor = "pointer";
            item.textContent = `${v.nome} (${v.telefone || "-"})`;
            item.onmouseover = () => item.style.background = "#f0f0f0";
            item.onmouseout = () => item.style.background = "white";
            item.onclick = () => {
              input.value = v.nome;
              const membro = input.closest(".membro");
              if (membro) {
                const telInput = membro.querySelector(".telefone-membro");
                if (telInput) telInput.value = v.telefone || "";
              }
              sugestoes.innerHTML = "";
            };
            sugestoes.appendChild(item);
          });
        });

        document.addEventListener("click", (e) => {
          if (!wrapper.contains(e.target)) {
            sugestoes.innerHTML = "";
          }
        });
      }

      // Inicialização
      document.addEventListener("DOMContentLoaded", async () => {
        // Verifica se já está autenticado
        const jaAutenticado = await verificarSessao();
        if (jaAutenticado) {
          mostrarPrincipal();
          await carregarVisitantes();
          // Aplica autocomplete no primeiro input
          document.querySelectorAll(".nome-membro").forEach(input => {
            setupAutocomplete(input);
          });
        } else {
          mostrarLogin();
        }

        // Form de login
        const loginForm = document.querySelector("#loginForm");
        const loginMsg = document.querySelector("#loginMsg");

        loginForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const senha = document.querySelector("#senha").value;

          const sucesso = await fazerLogin(senha);
          if (sucesso) {
            mostrarPrincipal();
            loginMsg.textContent = "";
          } else {
            loginMsg.textContent = "Senha incorreta";
            loginMsg.style.color = "red";
          }
        });

        // Adicionar membro
        document.querySelector("#adicionarMembro").addEventListener("click", adicionarMembro);

        // Form família
        const familiaForm = document.querySelector("#familiaForm");
        const msg = document.querySelector("#msg");

        familiaForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          
          const nomeFamilia = document.querySelector("#nomeFamilia").value.trim();
          const membrosElements = document.querySelectorAll(".membro");
          
          const membros = Array.from(membrosElements).map(el => ({
            nome: el.querySelector(".nome-membro").value.trim(),
            telefone: el.querySelector(".telefone-membro").value.trim(),
            parentesco: el.querySelector(".parentesco-membro").value
          })).filter(m => m.nome);

          if (!nomeFamilia || membros.length === 0) {
            msg.textContent = "Preencha o nome da família e pelo menos um membro";
            msg.style.color = "red";
            return;
          }

          const resultado = await cadastrarFamilia(nomeFamilia, membros);
          
          if (resultado && resultado.status === "ok") {
            msg.textContent = `Família "${nomeFamilia}" cadastrada com sucesso!`;
            msg.style.color = "green";
            familiaForm.reset();
          } else {
            msg.textContent = "Erro ao cadastrar família";
            msg.style.color = "red";
          }
        });
      });
    </script>
  </body>
</html>