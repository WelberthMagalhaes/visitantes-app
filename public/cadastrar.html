<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Cadastro de Visitantes</title>
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <!-- Tela de Login -->
    <div class="login-screen container">
      <h2>Acesso Ã  RecepÃ§Ã£o</h2>
      <form id="loginForm">
        <label for="senha">Senha:</label>
        <input id="senha" type="password" required />
        <button type="submit">Entrar</button>
      </form>
      <p id="loginMsg"></p>
    </div>

    <!-- Tela Principal -->
    <div class="main-screen container" style="display: none">
      <h2>Cadastro de Visitantes</h2>
      
      <div style="text-align: center; margin-bottom: 20px;">
        <a href="/visitantes-hoje.html" style="display: inline-block; padding: 10px 20px; background: #4a90e2; color: white; text-decoration: none; border-radius: 5px;">ðŸ“‹ Ver Visitantes de Hoje</a>
      </div>

      <form id="form">
        <div class="autocomplete-box">
          <label for="nome">Nome</label>
          <input id="nome" name="nome" autocomplete="off" required />
          <div id="sugestoes" class="sugestoes"></div>
        </div>

        <label for="telefone">Telefone</label>
        <input id="telefone" name="telefone" />

        <button type="submit">Registrar</button>
      </form>

      <p id="msg"></p>
    </div>

    <script>
      // ---------- utils
      function normaliza(str) {
        if (!str) return "";
        return str
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9 ]/g, "")
          .replace(/\s+/g, " ")
          .trim();
      }

      // -------- localStorage helpers
      function getVisitantesLocal() {
        return JSON.parse(localStorage.getItem("visitantesLocal") || "[]");
      }
      function salvarVisitantesLocal(lista) {
        localStorage.setItem("visitantesLocal", JSON.stringify(lista));
      }

      function adicionarVisitanteLocal(nome, telefone) {
        const lista = getVisitantesLocal();
        const nomeNorm = normaliza(nome);
        const existente = lista.find((v) => v.nomeNorm === nomeNorm);

        if (existente) {
          existente.visitas = (existente.visitas || 1) + 1;
          existente.telefone = telefone || existente.telefone;
          salvarVisitantesLocal(lista);
          return { tipo: "retorno", visitante: existente };
        }

        const novo = {
          id: crypto.randomUUID(),
          nome,
          nomeNorm,
          telefone,
          visitas: 1,
        };
        lista.push(novo);
        salvarVisitantesLocal(lista);
        return { tipo: "novo", visitante: novo };
      }

      function buscarVisitantesLocal(term) {
        if (!term) return [];
        const q = normaliza(term);
        return getVisitantesLocal().filter((v) => v.nomeNorm.includes(q));
      }

      // --------- UI autocomplete
      function setupAutoComplete() {
        const input = document.querySelector("#nome");
        const sugestoes = document.querySelector("#sugestoes");

        input.addEventListener("input", () => {
          const valor = input.value;
          const resultados = buscarVisitantesLocal(valor);
          sugestoes.innerHTML = "";

          resultados.slice(0, 10).forEach((v) => {
            const item = document.createElement("div");
            item.className = "sugestao-item";
            item.textContent = `${v.nome} (${v.telefone || "-"}) - visitas: ${v.visitas || 1}`;
            item.onclick = () => {
              document.querySelector("#nome").value = v.nome;
              document.querySelector("#telefone").value = v.telefone || "";
              sugestoes.innerHTML = "";
            };
            sugestoes.appendChild(item);
          });
        });
      }

      // ---------- autenticaÃ§Ã£o e sincronizaÃ§Ã£o
      const BASE = ""; // se precisar, coloque base url. por default requisita ao mesmo host
      let autenticado = false;

      // Faz login com senha fornecida
      async function fazerLogin(senha) {
        try {
          const res = await fetch((BASE || "") + "/interno/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ senha }),
          });

          if (res.ok) {
            autenticado = true;
            return true;
          }
        } catch (err) {
          console.error("Erro no login:", err);
        }
        return false;
      }

      // Mostra/esconde telas
      function mostrarLogin() {
        document.querySelector(".login-screen").style.display = "block";
        document.querySelector(".main-screen").style.display = "none";
      }

      function mostrarPrincipal() {
        document.querySelector(".login-screen").style.display = "none";
        document.querySelector(".main-screen").style.display = "block";
      }

      async function enviarAoBackend(nome, telefone) {
        if (!autenticado) return null;

        try {
          const payload = { nome, telefone };
          const headers = { "Content-Type": "application/json" };

          const res = await fetch((BASE || "") + "/interno/visitantes", {
            method: "POST",
            headers,
            body: JSON.stringify(payload),
          });

          return await res.json();
        } catch (err) {
          console.error("Erro enviando ao backend", err);
          return null;
        }
      }

      // ao carregar: baixa lista do backend e popula localStorage (sincroniza)
      async function sincronizarDoBackend() {
        if (!autenticado) return;

        try {
          // tenta baixar todos (rota interna) â€” caso queira apenas de hoje, adaptar
          const res = await fetch((BASE || "") + "/interno/visitantes/all");
          if (!res.ok) return;
          const lista = await res.json();

          // transforma e salva local (mantÃ©m locais existentes somando visitas)
          const local = getVisitantesLocal();
          const map = new Map(local.map((v) => [v.nomeNorm, v]));

          lista.forEach((v) => {
            const nomeNorm = normaliza(v.nome);
            const existente = map.get(nomeNorm);
            if (existente) {
              existente.visitas = Math.max(
                existente.visitas || 1,
                v.visitas || 1
              );
              existente.telefone = existente.telefone || v.telefone || "";
            } else {
              map.set(nomeNorm, {
                id: crypto.randomUUID(),
                nome: v.nome,
                nomeNorm,
                telefone: v.telefone || "",
                visitas: v.visitas || 1,
              });
            }
          });

          salvarVisitantesLocal(Array.from(map.values()));
        } catch (err) {
          console.warn("SincronizaÃ§Ã£o falhou:", err);
        }
      }

      // Verifica se jÃ¡ estÃ¡ autenticado
      async function verificarSessao() {
        try {
          const res = await fetch((BASE || "") + "/interno/visitantes/all");
          if (res.ok) {
            autenticado = true;
            return true;
          }
        } catch (err) {
          console.log("SessÃ£o nÃ£o ativa");
        }
        return false;
      }

      // ---------- inicializaÃ§Ã£o
      document.addEventListener("DOMContentLoaded", async () => {
        setupAutoComplete();
        
        // Verifica se jÃ¡ estÃ¡ autenticado
        const jaAutenticado = await verificarSessao();
        if (jaAutenticado) {
          mostrarPrincipal();
          await sincronizarDoBackend();
        } else {
          mostrarLogin();
        }

        // Form de login
        const loginForm = document.querySelector("#loginForm");
        const loginMsg = document.querySelector("#loginMsg");

        loginForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const senha = document.querySelector("#senha").value;

          const sucesso = await fazerLogin(senha);
          if (sucesso) {
            mostrarPrincipal();
            await sincronizarDoBackend();
            loginMsg.textContent = "";
          } else {
            loginMsg.textContent = "Senha incorreta";
            loginMsg.style.color = "red";
          }
        });

        // Form principal
        const form = document.querySelector("#form");
        const msg = document.querySelector("#msg");

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const nome = document.querySelector("#nome").value.trim();
          const telefone = document.querySelector("#telefone").value.trim();

          if (!nome) return;

          // tenta enviar ao backend primeiro
          const backendRes = await enviarAoBackend(nome, telefone);

          if (backendRes && backendRes.status === "ok") {
            if (backendRes.res.tipo === "ja_cadastrado_hoje") {
              msg.textContent = "Visitante jÃ¡ foi cadastrado hoje!";
              msg.style.color = "orange";
            } else {
              // sÃ³ adiciona local se backend permitiu
              const localRes = adicionarVisitanteLocal(nome, telefone);

              if (backendRes.res.tipo === "novo")
                msg.textContent = "Visitante cadastrado";
              else msg.textContent = "Visitante retorno marcado";

              msg.textContent += " â€” sincronizado";
              msg.style.color = "green";
            }
          } else {
            // fallback: adiciona sÃ³ local se backend falhou
            const localRes = adicionarVisitanteLocal(nome, telefone);

            if (localRes.tipo === "novo")
              msg.textContent = "Visitante cadastrado (apenas local)";
            else msg.textContent = "Visitante retorno marcado (apenas local)";

            msg.style.color = "red";
          }

          form.reset();
        });
      });
    </script>
  </body>
</html>
