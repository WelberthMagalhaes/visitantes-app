<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Cadastro de Visitantes</title>
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body style="visibility: hidden">
    <!-- Tela de Login -->
    <div class="login-screen container" style="display: none">
      <h2>Acesso Ã  RecepÃ§Ã£o</h2>
      <form id="loginForm">
        <label for="senha">Senha:</label>
        <input id="senha" type="password" required />
        <button type="submit">Entrar</button>
      </form>
      <p id="loginMsg"></p>
    </div>

    <!-- Tela Principal -->
    <div class="main-screen container" style="display: none">
      <h2>Cadastro de Visitantes</h2>

      <div style="text-align: center; margin-bottom: 20px">
        <a
          href="/visitantes-hoje.html"
          style="
            display: inline-block;
            padding: 10px 20px;
            background: #4a90e2;
            color: white;
            text-decoration: none;
            border-radius: 5px;
          "
          >ðŸ“‹ Ver Visitantes de Hoje</a
        >
        <button
          id="btnSync"
          style="
            margin-left: 10px;
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
          "
        >
          ðŸ”„ Sincronizar
        </button>
      </div>
      <p id="syncMsg" style="text-align: center; color: #666"></p>

      <form id="form">
        <div class="autocomplete-box">
          <label for="nome">Nome</label>
          <input id="nome" name="nome" autocomplete="off" required />
          <div id="sugestoes" class="sugestoes"></div>
        </div>

        <label for="telefone">Telefone</label>
        <input
          id="telefone"
          name="telefone"
          placeholder="(31) 98877-6655"
          maxlength="15"
        />

        <label for="acompanhantes">Acompanhantes</label>
        <input
          id="acompanhantes"
          name="acompanhantes"
          type="number"
          min="0"
          value="0"
        />

        <label for="observacao">ObservaÃ§Ã£o</label>
        <textarea
          id="observacao"
          name="observacao"
          rows="3"
          placeholder="Ex: Esposa Maria, filhos Pedro e Ana"
        ></textarea>

        <button type="submit">Registrar</button>
      </form>

      <p id="msg"></p>
    </div>

    <script>
      // ---------- utils
      function normaliza(str) {
        if (!str) return "";
        return str
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-z0-9 ]/g, "")
          .replace(/\s+/g, " ")
          .trim();
      }

      // -------- localStorage helpers
      function getVisitantesLocal() {
        return JSON.parse(localStorage.getItem("visitantesLocal") || "[]");
      }
      function salvarVisitantesLocal(lista) {
        localStorage.setItem("visitantesLocal", JSON.stringify(lista));
      }

      function adicionarVisitanteLocal(nome, telefone) {
        const lista = getVisitantesLocal();
        const nomeNorm = normaliza(nome);
        const hoje = new Date().toISOString().split("T")[0]; // YYYY-MM-DD
        const existente = lista.find((v) => v.nomeNorm === nomeNorm);

        if (existente) {
          // Verifica se jÃ¡ cadastrou hoje
          if (existente.ultima_visita === hoje) {
            return { tipo: "ja_cadastrado_hoje", visitante: existente };
          }

          // Atualiza visita
          existente.visitas = (existente.visitas || 1) + 1;
          existente.telefone = telefone || existente.telefone;
          existente.ultima_visita = hoje;
          salvarVisitantesLocal(lista);
          return { tipo: "retorno", visitante: existente };
        }

        const novo = {
          id: crypto.randomUUID(),
          nome,
          nomeNorm,
          telefone,
          visitas: 1,
          ultima_visita: hoje,
        };
        lista.push(novo);
        salvarVisitantesLocal(lista);
        return { tipo: "novo", visitante: novo };
      }

      function buscarVisitantesLocal(term) {
        if (!term) return [];
        const q = normaliza(term);
        return getVisitantesLocal().filter((v) => v.nomeNorm.includes(q));
      }

      // --------- MÃ¡scara de telefone
      function mascaraTelefone(valor) {
        valor = valor.replace(/\D/g, "");
        if (valor.length <= 10) {
          // Fixo: (31) 3524-4564
          valor = valor.replace(/(\d{2})(\d)/, "($1) $2");
          valor = valor.replace(/(\d{4})(\d)/, "$1-$2");
        } else {
          // Celular: (31) 98877-6655
          valor = valor.replace(/(\d{2})(\d)/, "($1) $2");
          valor = valor.replace(/(\d{5})(\d)/, "$1-$2");
        }
        return valor;
      }

      // --------- UI autocomplete
      function setupAutoComplete() {
        const input = document.querySelector("#nome");
        const sugestoes = document.querySelector("#sugestoes");

        input.addEventListener("input", () => {
          const valor = input.value;
          const resultados = buscarVisitantesLocal(valor);
          sugestoes.innerHTML = "";

          resultados.slice(0, 10).forEach((v) => {
            const item = document.createElement("div");
            item.className = "sugestao-item";
            item.textContent = `${v.nome} (${v.telefone || "-"}) - visitas: ${v.visitas || 1}`;
            item.onclick = () => {
              document.querySelector("#nome").value = v.nome;
              const telInput = document.querySelector("#telefone");
              telInput.value = mascaraTelefone(v.telefone || "");
              sugestoes.innerHTML = "";
            };
            sugestoes.appendChild(item);
          });
        });
      }

      // ---------- autenticaÃ§Ã£o e sincronizaÃ§Ã£o
      const BASE = ""; // se precisar, coloque base url. por default requisita ao mesmo host
      let autenticado = false;
      let dadosCache = null;

      // Faz login com senha fornecida
      async function fazerLogin(senha) {
        try {
          const res = await fetch((BASE || "") + "/interno/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ senha }),
          });

          if (res.ok) {
            autenticado = true;
            return true;
          }
        } catch (err) {
          console.error("Erro no login:", err);
        }
        return false;
      }

      // Mostra/esconde telas
      function mostrarLogin() {
        document.querySelector(".login-screen").style.display = "block";
        document.querySelector(".main-screen").style.display = "none";
      }

      function mostrarPrincipal() {
        document.querySelector(".login-screen").style.display = "none";
        document.querySelector(".main-screen").style.display = "block";
      }

      async function enviarAoBackend(
        nome,
        telefone,
        acompanhantes,
        observacao
      ) {
        if (!autenticado) return null;

        try {
          const payload = { nome, telefone, acompanhantes, observacao };
          const headers = { "Content-Type": "application/json" };

          const res = await fetch((BASE || "") + "/interno/visitantes", {
            method: "POST",
            headers,
            body: JSON.stringify(payload),
          });

          return await res.json();
        } catch (err) {
          console.error("Erro enviando ao backend", err);
          return null;
        }
      }

      // SincronizaÃ§Ã£o bidirecional: envia locais -> servidor, depois baixa servidor -> local
      async function sincronizarDoBackend(usarCache = false) {
        if (!autenticado) return;

        try {
          const local = getVisitantesLocal();

          // 1. Envia dados locais para o servidor
          if (local.length > 0) {
            await fetch((BASE || "") + "/interno/sync", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ visitantes: local }),
            });
          }

          // 2. Baixa dados atualizados do servidor (ou usa cache)
          let listaServidor;

          if (usarCache && dadosCache) {
            listaServidor = dadosCache;
            dadosCache = null;
          } else {
            const res = await fetch((BASE || "") + "/interno/visitantes/all");
            if (!res.ok) return;
            listaServidor = await res.json();
          }

          // 3. Atualiza localStorage com dados do servidor (servidor Ã© fonte da verdade)
          const map = new Map();

          listaServidor.forEach((v) => {
            const nomeNorm = normaliza(v.nome);
            map.set(nomeNorm, {
              id: crypto.randomUUID(),
              nome: v.nome,
              nomeNorm,
              telefone: v.telefone || "",
              visitas: v.visitas || 1,
              ultima_visita: v.ultima_visita || null, // Traz data do servidor
            });
          });

          salvarVisitantesLocal(Array.from(map.values()));
        } catch (err) {
          console.warn("SincronizaÃ§Ã£o falhou:", err);
        }
      }

      // Verifica se jÃ¡ estÃ¡ autenticado
      async function verificarSessao() {
        try {
          const res = await fetch((BASE || "") + "/interno/visitantes/all");
          if (res.ok) {
            autenticado = true;
            dadosCache = await res.json();
            return true;
          }
        } catch (err) {
          console.log("SessÃ£o nÃ£o ativa");
        }
        return false;
      }

      // ---------- inicializaÃ§Ã£o
      document.addEventListener("DOMContentLoaded", async () => {
        setupAutoComplete();

        // Aplicar mÃ¡scara no telefone
        const telInput = document.querySelector("#telefone");
        telInput.addEventListener("input", (e) => {
          e.target.value = mascaraTelefone(e.target.value);
        });

        // Verifica se jÃ¡ estÃ¡ autenticado
        const jaAutenticado = await verificarSessao();

        // Mostra o body apÃ³s verificar sessÃ£o
        document.body.style.visibility = "visible";

        if (jaAutenticado) {
          mostrarPrincipal();
          await sincronizarDoBackend(true); // Usa cache da verificaÃ§Ã£o
        } else {
          mostrarLogin();
        }

        // Form de login
        const loginForm = document.querySelector("#loginForm");
        const loginMsg = document.querySelector("#loginMsg");

        loginForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const senha = document.querySelector("#senha").value;

          const sucesso = await fazerLogin(senha);
          if (sucesso) {
            mostrarPrincipal();
            await sincronizarDoBackend();
            loginMsg.textContent = "";
          } else {
            loginMsg.textContent = "Senha incorreta";
            loginMsg.style.color = "red";
          }
        });

        // Form principal
        const form = document.querySelector("#form");
        const msg = document.querySelector("#msg");

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const nome = document.querySelector("#nome").value.trim();
          const telefone = document.querySelector("#telefone").value.trim();
          const acompanhantes =
            parseInt(document.querySelector("#acompanhantes").value) || 0;
          const observacao = document.querySelector("#observacao").value.trim();

          if (!nome) return;

          // tenta enviar ao backend primeiro
          const backendRes = await enviarAoBackend(
            nome,
            telefone,
            acompanhantes,
            observacao
          );

          if (backendRes && backendRes.status === "ok") {
            if (backendRes.res.tipo === "ja_cadastrado_hoje") {
              msg.textContent = "Visitante jÃ¡ foi cadastrado hoje!";
              msg.style.color = "orange";
            } else {
              // sÃ³ adiciona local se backend permitiu
              const localRes = adicionarVisitanteLocal(nome, telefone);

              if (backendRes.res.tipo === "novo")
                msg.textContent = "Visitante cadastrado";
              else msg.textContent = "Visitante retorno marcado";

              msg.textContent += " â€” sincronizado";
              msg.style.color = "green";
            }
          } else {
            // fallback: adiciona sÃ³ local se backend falhou
            const localRes = adicionarVisitanteLocal(nome, telefone);

            if (localRes.tipo === "ja_cadastrado_hoje") {
              msg.textContent = "Visitante jÃ¡ foi cadastrado hoje (local)!";
              msg.style.color = "orange";
            } else if (localRes.tipo === "novo") {
              msg.textContent = "Visitante cadastrado (apenas local)";
              msg.style.color = "red";
            } else {
              msg.textContent = "Visitante retorno marcado (apenas local)";
              msg.style.color = "red";
            }
          }

          // Limpa mensagem apÃ³s 3 segundos
          setTimeout(() => {
            msg.textContent = "";
          }, 3000);

          form.reset();
        });

        // BotÃ£o de sincronizaÃ§Ã£o manual
        const btnSync = document.querySelector("#btnSync");
        const syncMsg = document.querySelector("#syncMsg");

        btnSync.addEventListener("click", async () => {
          syncMsg.textContent = "Sincronizando...";
          syncMsg.style.color = "#666";

          await sincronizarDoBackend();

          syncMsg.textContent = "âœ“ Sincronizado com sucesso!";
          syncMsg.style.color = "green";

          setTimeout(() => {
            syncMsg.textContent = "";
          }, 3000);
        });
      });
    </script>
  </body>
</html>
